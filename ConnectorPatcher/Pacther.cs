using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Text;
using System.IO;
using System.Windows.Forms;

namespace ConnectorPatcher
{
    public partial class Form_Pacther : Form
    {
        string DropFileName = "LineageConnector.exe";
        public Form_Pacther()
        {
            InitializeComponent();
            
        }

        private void button_Edit_Click(object sender, EventArgs e)
        {
            byte[] File = Properties.Resources.LineageConnector;

            Edit(File);

        }

        byte[] IP_String = new byte[] { 0x73, 0x00, 0x65, 0x00, 0x72, 0x00, 0x76, 0x00, 0x65, 0x00, 0x72, 0x00, 0x5F, 0x00, 0x61, 0x00, 0x64, 0x00, 0x64, 0x00, 0x72, 0x00, 0x65, 0x00, 0x73, 0x00, 0x73, 0x00, 0x5F, 0x00, 0x73, 0x00, 0x74, 0x00, 0x61, 0x00, 0x72, 0x00, 0x74, 0x00, 0x5F, 0x00, 0x31, 0x00, 0x32, 0x00, 0x37, 0x00, 0x2E, 0x00, 0x30, 0x00, 0x2E, 0x00, 0x30, 0x00, 0x2E, 0x00, 0x31, 0x00, 0x5F, 0x00, 0x73, 0x00, 0x65, 0x00, 0x72, 0x00, 0x76, 0x00, 0x65, 0x00, 0x72, 0x00, 0x5F, 0x00, 0x61, 0x00, 0x64, 0x00, 0x64, 0x00, 0x72, 0x00, 0x65, 0x00, 0x73, 0x00, 0x73, 0x00, 0x5F, 0x00, 0x65, 0x00, 0x6E, 0x00, 0x64, 0x00, 0x5F, 0x00, 0x72, 0x00, 0x65, 0x00, 0x61, 0x00, 0x6C, 0x00, 0x6C, 0x00, 0x79, 0x00, 0x5F, 0x00, 0x65, 0x00, 0x6E, 0x00, 0x64, 0x00 }; //s.e.r.v.e.r._.a.d.d.r.e.s.s._.s.t.a.r.t._.1.2.7...0...0...1._.s.e.r.v.e.r._.a.d.d.r.e.s.s._.e.n.d._.r.e.a.l.l.y._.e.n.d.
        byte[] serverPort_String = new byte[] { 0x70, 0x00, 0x70, 0x00, 0x70, 0x00, 0x70, 0x00, 0x70, 0x00, 0x70, 0x00, 0x70, 0x00, 0x70, 0x00, 0x6F, 0x00, 0x72, 0x00, 0x74, 0x00, 0x5F, 0x00, 0x6C, 0x00, 0x69, 0x00, 0x6E, 0x00, 0x61, 0x00, 0x67, 0x00, 0x65, 0x00, 0x5F, 0x00, 0x32, 0x00, 0x30, 0x00, 0x30, 0x00, 0x30, 0x00 }; //p.p.p.p.p.p.p.p.o.r.t._.l.i.n.a.g.e._.2.0.0.0.
        byte[] paymentserverPort_String = new byte[] { 0x70, 0x00, 0x70, 0x00, 0x70, 0x00, 0x70, 0x00, 0x70, 0x00, 0x70, 0x00, 0x70, 0x00, 0x70, 0x00, 0x6F, 0x00, 0x72, 0x00, 0x74, 0x00, 0x5F, 0x00, 0x70, 0x00, 0x61, 0x00, 0x79, 0x00, 0x6D, 0x00, 0x65, 0x00, 0x6E, 0x00, 0x74, 0x00, 0x5F, 0x00, 0x32, 0x00, 0x30, 0x00, 0x30, 0x00, 0x32, 0x00 }; //p.p.p.p.p.p.p.o.r.t._.p.a.y.m.e.n.t._.2.0.0.2.
        byte[] LeftUnderMessage_String = new byte[] { 0x00, 0x30, 0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x00, 0x30, 0x00, 0x30, 0x00, 0x30, 0x00, 0x30, 0x00, 0x30, 0x00, 0x30, 0x00, 0x30, 0x00, 0x30, 0x00, 0x30, 0x00, 0x30 }; //[　       　　　　　　　　　　] 공백 18글자

        private void Edit(byte[] bFile)
        {
            Set(bFile, IP_String, textBox_IP.Text);
            Set(bFile, serverPort_String, textBox_ServerPort.Text);
            Set(bFile, paymentserverPort_String, textBox_PaymentServerPort.Text);
            Set(bFile, LeftUnderMessage_String, textBox_LeftUnderMessage.Text);

            try
            {
                File.WriteAllBytes(DropFileName, bFile);
            }
            catch(Exception ex)
            {
                MessageBox.Show(ex.Message + "\n" + DropFileName + "파일 생성에 실패했습니다.");
                return;
            }

            MessageBox.Show(DropFileName + "파일을 성공적으로 생성했습니다!");
        }

        private void Set(byte[] File, byte[] Find, string Set)
        {
            byte[] v = Encoding.Unicode.GetBytes(Set);
            for (int i = 0; i < File.Length - 4; i++)
            {
                bool Found = true;
                for (int j = 0; j < Find.Length; j++)
                {
                    if (File[i + j] != Find[j]) { Found = false; break; }
                }
                if (!Found) continue;

                for (int j = 0; j < Find.Length; j++)
                    File[i + j] = 0; //00으로 초기화

                for (int j = 0; j < v.Length; j++)
                    File[i + j] = v[j];
            }
        }
    }
}
